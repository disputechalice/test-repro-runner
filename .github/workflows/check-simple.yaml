name: repro-checks

on:
  workflow_call:
    inputs:
      url:
        required: true
        type: string
      ref:
        required: true
        type: string

defaults:
  run:
    shell: bash

jobs:

  prepare:
    runs-on: ubuntu-latest
    env:
      GIT_URL: ${{ inputs.url }}
      GIT_COMMIT: ${{ inputs.ref }}
    steps:

      - name: Get kit repo
        uses: disputechalice/test-gh-actions/checkout-archive@main
        with:
          repo: https://github.com/"$GITHUB_REPOSITORY".git
          ref: main
          dir: kit

      - name: Get source repo
        uses: disputechalice/test-gh-actions/checkout-archive@main
        with:
          repo: ${{ inputs.url }}
          ref: ${{ inputs.ref }}
          dir: gitrepo
          permsrc: true

      - name: Prep environment
        run: |
          mkdir -p env

          export GIT_DIR="gitrepo.git"

          tee -a env/prep.env >&2 << EOF
          GIT_URL=$(git remote get-url origin)
          GIT_COMMIT=$(git rev-parse HEAD)
          EOF

          found_buildmeta=(gitrepo/*.buildmeta)
          ((${#found_buildmeta[@]} == 1))
          buildmeta=${found_buildmeta[0]}
          [[ -f $buildmeta ]]
          buildmeta_fname=${buildmeta##*/}

          target="${buildmeta_fname%%.buildmeta}"
          package=${target%%_*}
          version=${target#*_}

          source "$buildmeta" || return 255

          tee -a "env/prep.env" >&2 << EOF
          DEB_PACKAGE=$package
          DEB_VERSION=$version

          SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH
          DPKG_DEB_COMPRESSOR_TYPE=$DPKG_DEB_COMPRESSOR_TYPE

          DEB_SHA256=$DEB_SHA256
          DEB_URL=$DEB_URL
          EOF

      - name: Upload environment
        uses: actions/upload-artifact@v4
        with:
          name: prep-env-dir
          path: env

  repro:  
    runs-on: ubuntu-latest
    container: ghcr.io/disputechalice/builder-simple:latest
    needs: prep-env
    steps:
      - name: Prep
        uses: disputechalice/test-gh-actions/prep@main

      - name: Check if build can be reproduced
        run: |
          source env/prep.env
          export DEB_{PACKAGE,VERSION,SHA256} \
            SOURCE_DATE_EPOCH DPKG_DEB_COMPRESSOR_TYPE

          kit/check-repro-simple gitrepo

  dist:
    runs-on: ubuntu-latest
    needs: prep-env
    steps:
      - name: Prep
        uses: disputechalice/test-gh-actions/prep@main

      - name: Check if published package checksum matches
        run: |
          source env/prep.env
          export DEB_{PACKAGE,SHA256,URL}

          kit/check-dist

  report:
    runs-on: ubuntu-latest
    needs: [repro, dist]
    steps:
      - name: Download environment
        uses: actions/download-artifact@v4
        with:
          name: prep-env-dir
          path: ./env

      - name: Run report
        run: |
          for f in env/*.env; do source "$f"; done

          # [[ $CHECK_BUILD == "pass" ]]

          tee "report.md" >&2 << EOF
          As of: **$(date --rfc-3339=seconds --utc)**

          ## Build reproducibility confirmed

          ### Package
          *$DEB_PACKAGE*

          ### Version
          *$DEB_VERSION*

          ### Source URL
          [$GIT_URL]($GIT_URL)

          ### Source Git commit SHA
          $GIT_COMMIT

          ### Package checksum SHA256

          $DEB_SHA256
          EOF

          # [[ $CHECK_URL == "pass" ]]

          tee -a "report.md" >&2 << EOF

          ## Published package checksum verified

          ### Package URL
          [$DEB_URL]($DEB_URL)

          Checksum matches that of the reproduced build.
          EOF

          cat report.md >> $GITHUB_STEP_SUMMARY
